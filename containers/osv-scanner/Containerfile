# OSv scanner runner container (wraps an OSv image and runs it via qemu)
# Usage:
#   podman build -t osv-scanner:latest \
#     --build-arg OSV_IMAGE=./osv.img \
#     -f containers/osv-scanner/Containerfile .
#   podman run --rm --net=host --device /dev/kvm osv-scanner:latest \
#     --cidr 10.0.0.0/8 --ports 80,443 --rate 200000
#
# Notes:
# - Provide a valid OSv image via OSV_IMAGE build-arg; it is copied into the image.
# - The entrypoint runs qemu-system-x86_64 with KVM if /dev/kvm is available, TCG otherwise.
# - The OSv image should boot into your scanner app and consume CLI flags passed to this container;
#   they are forwarded to the OSv command line via -append.

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    qemu-system-x86 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

ARG OSV_IMAGE
# Copy OSv image into container; if not provided, leave a placeholder
RUN mkdir -p /opt/osv
COPY ${OSV_IMAGE:-containers/osv-scanner/placeholder.osv.img} /opt/osv/osv.img

# Runner script
COPY run.sh /usr/local/bin/osv-run
RUN chmod +x /usr/local/bin/osv-run

WORKDIR /opt/osv
ENTRYPOINT ["/usr/local/bin/osv-run"]
