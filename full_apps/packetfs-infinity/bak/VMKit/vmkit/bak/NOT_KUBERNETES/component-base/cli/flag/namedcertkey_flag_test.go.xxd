00000000: 2f2a 0a43 6f70 7972 6967 6874 2032 3031  /*.Copyright 201
00000010: 3620 5468 6520 4b75 6265 726e 6574 6573  6 The Kubernetes
00000020: 2041 7574 686f 7273 2e0a 0a4c 6963 656e   Authors...Licen
00000030: 7365 6420 756e 6465 7220 7468 6520 4170  sed under the Ap
00000040: 6163 6865 204c 6963 656e 7365 2c20 5665  ache License, Ve
00000050: 7273 696f 6e20 322e 3020 2874 6865 2022  rsion 2.0 (the "
00000060: 4c69 6365 6e73 6522 293b 0a79 6f75 206d  License");.you m
00000070: 6179 206e 6f74 2075 7365 2074 6869 7320  ay not use this 
00000080: 6669 6c65 2065 7863 6570 7420 696e 2063  file except in c
00000090: 6f6d 706c 6961 6e63 6520 7769 7468 2074  ompliance with t
000000a0: 6865 204c 6963 656e 7365 2e0a 596f 7520  he License..You 
000000b0: 6d61 7920 6f62 7461 696e 2061 2063 6f70  may obtain a cop
000000c0: 7920 6f66 2074 6865 204c 6963 656e 7365  y of the License
000000d0: 2061 740a 0a20 2020 2068 7474 703a 2f2f   at..    http://
000000e0: 7777 772e 6170 6163 6865 2e6f 7267 2f6c  www.apache.org/l
000000f0: 6963 656e 7365 732f 4c49 4345 4e53 452d  icenses/LICENSE-
00000100: 322e 300a 0a55 6e6c 6573 7320 7265 7175  2.0..Unless requ
00000110: 6972 6564 2062 7920 6170 706c 6963 6162  ired by applicab
00000120: 6c65 206c 6177 206f 7220 6167 7265 6564  le law or agreed
00000130: 2074 6f20 696e 2077 7269 7469 6e67 2c20   to in writing, 
00000140: 736f 6674 7761 7265 0a64 6973 7472 6962  software.distrib
00000150: 7574 6564 2075 6e64 6572 2074 6865 204c  uted under the L
00000160: 6963 656e 7365 2069 7320 6469 7374 7269  icense is distri
00000170: 6275 7465 6420 6f6e 2061 6e20 2241 5320  buted on an "AS 
00000180: 4953 2220 4241 5349 532c 0a57 4954 484f  IS" BASIS,.WITHO
00000190: 5554 2057 4152 5241 4e54 4945 5320 4f52  UT WARRANTIES OR
000001a0: 2043 4f4e 4449 5449 4f4e 5320 4f46 2041   CONDITIONS OF A
000001b0: 4e59 204b 494e 442c 2065 6974 6865 7220  NY KIND, either 
000001c0: 6578 7072 6573 7320 6f72 2069 6d70 6c69  express or impli
000001d0: 6564 2e0a 5365 6520 7468 6520 4c69 6365  ed..See the Lice
000001e0: 6e73 6520 666f 7220 7468 6520 7370 6563  nse for the spec
000001f0: 6966 6963 206c 616e 6775 6167 6520 676f  ific language go
00000200: 7665 726e 696e 6720 7065 726d 6973 7369  verning permissi
00000210: 6f6e 7320 616e 640a 6c69 6d69 7461 7469  ons and.limitati
00000220: 6f6e 7320 756e 6465 7220 7468 6520 4c69  ons under the Li
00000230: 6365 6e73 652e 0a2a 2f0a 0a70 6163 6b61  cense..*/..packa
00000240: 6765 2066 6c61 670a 0a69 6d70 6f72 7420  ge flag..import 
00000250: 280a 0922 666d 7422 0a09 2272 6566 6c65  (.."fmt".."refle
00000260: 6374 220a 0922 7374 7269 6e67 7322 0a09  ct".."strings"..
00000270: 2274 6573 7469 6e67 220a 0a09 2267 6974  "testing"..."git
00000280: 6875 622e 636f 6d2f 7370 6631 332f 7066  hub.com/spf13/pf
00000290: 6c61 6722 0a29 0a0a 6675 6e63 2054 6573  lag".)..func Tes
000002a0: 744e 616d 6564 4365 7274 4b65 7941 7272  tNamedCertKeyArr
000002b0: 6179 466c 6167 2874 202a 7465 7374 696e  ayFlag(t *testin
000002c0: 672e 5429 207b 0a09 7465 7374 7320 3a3d  g.T) {..tests :=
000002d0: 205b 5d73 7472 7563 7420 7b0a 0909 6172   []struct {...ar
000002e0: 6773 2020 2020 2020 205b 5d73 7472 696e  gs       []strin
000002f0: 670a 0909 6465 6620 2020 2020 2020 205b  g...def        [
00000300: 5d4e 616d 6564 4365 7274 4b65 790a 0909  ]NamedCertKey...
00000310: 6578 7065 6374 6564 2020 205b 5d4e 616d  expected   []Nam
00000320: 6564 4365 7274 4b65 790a 0909 7061 7273  edCertKey...pars
00000330: 6545 7272 6f72 2073 7472 696e 670a 097d  eError string..}
00000340: 7b0a 0909 7b0a 0909 0961 7267 733a 2020  {...{....args:  
00000350: 2020 205b 5d73 7472 696e 677b 7d2c 0a09     []string{},..
00000360: 0909 6578 7065 6374 6564 3a20 6e69 6c2c  ..expected: nil,
00000370: 0a09 097d 2c0a 0909 7b0a 0909 0961 7267  ...},...{....arg
00000380: 733a 205b 5d73 7472 696e 677b 2266 6f6f  s: []string{"foo
00000390: 2e63 7274 2c66 6f6f 2e6b 6579 227d 2c0a  .crt,foo.key"},.
000003a0: 0909 0965 7870 6563 7465 643a 205b 5d4e  ...expected: []N
000003b0: 616d 6564 4365 7274 4b65 797b 7b0a 0909  amedCertKey{{...
000003c0: 0909 4b65 7946 696c 653a 2020 2266 6f6f  ..KeyFile:  "foo
000003d0: 2e6b 6579 222c 0a09 0909 0943 6572 7446  .key",.....CertF
000003e0: 696c 653a 2022 666f 6f2e 6372 7422 2c0a  ile: "foo.crt",.
000003f0: 0909 097d 7d2c 0a09 097d 2c0a 0909 7b0a  ...}},...},...{.
00000400: 0909 0961 7267 733a 205b 5d73 7472 696e  ...args: []strin
00000410: 677b 2220 2066 6f6f 2e63 7274 202c 2066  g{"  foo.crt , f
00000420: 6f6f 2e6b 6579 2020 2020 227d 2c0a 0909  oo.key    "},...
00000430: 0965 7870 6563 7465 643a 205b 5d4e 616d  .expected: []Nam
00000440: 6564 4365 7274 4b65 797b 7b0a 0909 0909  edCertKey{{.....
00000450: 4b65 7946 696c 653a 2020 2266 6f6f 2e6b  KeyFile:  "foo.k
00000460: 6579 222c 0a09 0909 0943 6572 7446 696c  ey",.....CertFil
00000470: 653a 2022 666f 6f2e 6372 7422 2c0a 0909  e: "foo.crt",...
00000480: 097d 7d2c 0a09 097d 2c0a 0909 7b0a 0909  .}},...},...{...
00000490: 0961 7267 733a 205b 5d73 7472 696e 677b  .args: []string{
000004a0: 2266 6f6f 2e63 7274 2c66 6f6f 2e6b 6579  "foo.crt,foo.key
000004b0: 3a61 6263 227d 2c0a 0909 0965 7870 6563  :abc"},....expec
000004c0: 7465 643a 205b 5d4e 616d 6564 4365 7274  ted: []NamedCert
000004d0: 4b65 797b 7b0a 0909 0909 4b65 7946 696c  Key{{.....KeyFil
000004e0: 653a 2020 2266 6f6f 2e6b 6579 222c 0a09  e:  "foo.key",..
000004f0: 0909 0943 6572 7446 696c 653a 2022 666f  ...CertFile: "fo
00000500: 6f2e 6372 7422 2c0a 0909 0909 4e61 6d65  o.crt",.....Name
00000510: 733a 2020 2020 5b5d 7374 7269 6e67 7b22  s:    []string{"
00000520: 6162 6322 7d2c 0a09 0909 7d7d 2c0a 0909  abc"},....}},...
00000530: 7d2c 0a09 097b 0a09 0909 6172 6773 3a20  },...{....args: 
00000540: 5b5d 7374 7269 6e67 7b22 666f 6f2e 6372  []string{"foo.cr
00000550: 742c 666f 6f2e 6b65 793a 2061 6263 2020  t,foo.key: abc  
00000560: 227d 2c0a 0909 0965 7870 6563 7465 643a  "},....expected:
00000570: 205b 5d4e 616d 6564 4365 7274 4b65 797b   []NamedCertKey{
00000580: 7b0a 0909 0909 4b65 7946 696c 653a 2020  {.....KeyFile:  
00000590: 2266 6f6f 2e6b 6579 222c 0a09 0909 0943  "foo.key",.....C
000005a0: 6572 7446 696c 653a 2022 666f 6f2e 6372  ertFile: "foo.cr
000005b0: 7422 2c0a 0909 0909 4e61 6d65 733a 2020  t",.....Names:  
000005c0: 2020 5b5d 7374 7269 6e67 7b22 6162 6322    []string{"abc"
000005d0: 7d2c 0a09 0909 7d7d 2c0a 0909 7d2c 0a09  },....}},...},..
000005e0: 097b 0a09 0909 6172 6773 3a20 2020 2020  .{....args:     
000005f0: 2020 5b5d 7374 7269 6e67 7b22 666f 6f2e    []string{"foo.
00000600: 6372 742c 666f 6f2e 6b65 793a 227d 2c0a  crt,foo.key:"},.
00000610: 0909 0970 6172 7365 4572 726f 723a 2022  ...parseError: "
00000620: 656d 7074 7920 6e61 6d65 7320 6c69 7374  empty names list
00000630: 2069 7320 6e6f 7420 616c 6c6f 7765 6422   is not allowed"
00000640: 2c0a 0909 7d2c 0a09 097b 0a09 0909 6172  ,...},...{....ar
00000650: 6773 3a20 2020 2020 2020 5b5d 7374 7269  gs:       []stri
00000660: 6e67 7b22 227d 2c0a 0909 0970 6172 7365  ng{""},....parse
00000670: 4572 726f 723a 2022 6578 7065 6374 6564  Error: "expected
00000680: 2063 6f6d 6d61 2073 6570 6172 6174 6564   comma separated
00000690: 2063 6572 7469 6669 6361 7465 2061 6e64   certificate and
000006a0: 206b 6579 2066 696c 6520 7061 7468 7322   key file paths"
000006b0: 2c0a 0909 7d2c 0a09 097b 0a09 0909 6172  ,...},...{....ar
000006c0: 6773 3a20 2020 2020 2020 5b5d 7374 7269  gs:       []stri
000006d0: 6e67 7b22 2020 2022 7d2c 0a09 0909 7061  ng{"   "},....pa
000006e0: 7273 6545 7272 6f72 3a20 2265 7870 6563  rseError: "expec
000006f0: 7465 6420 636f 6d6d 6120 7365 7061 7261  ted comma separa
00000700: 7465 6420 6365 7274 6966 6963 6174 6520  ted certificate 
00000710: 616e 6420 6b65 7920 6669 6c65 2070 6174  and key file pat
00000720: 6873 222c 0a09 097d 2c0a 0909 7b0a 0909  hs",...},...{...
00000730: 0961 7267 733a 2020 2020 2020 205b 5d73  .args:       []s
00000740: 7472 696e 677b 2261 2c62 2c63 227d 2c0a  tring{"a,b,c"},.
00000750: 0909 0970 6172 7365 4572 726f 723a 2022  ...parseError: "
00000760: 6578 7065 6374 6564 2063 6f6d 6d61 2073  expected comma s
00000770: 6570 6172 6174 6564 2063 6572 7469 6669  eparated certifi
00000780: 6361 7465 2061 6e64 206b 6579 2066 696c  cate and key fil
00000790: 6520 7061 7468 7322 2c0a 0909 7d2c 0a09  e paths",...},..
000007a0: 097b 0a09 0909 6172 6773 3a20 5b5d 7374  .{....args: []st
000007b0: 7269 6e67 7b22 666f 6f2e 6372 742c 666f  ring{"foo.crt,fo
000007c0: 6f2e 6b65 793a 6162 632c 6465 662c 6768  o.key:abc,def,gh
000007d0: 6922 7d2c 0a09 0909 6578 7065 6374 6564  i"},....expected
000007e0: 3a20 5b5d 4e61 6d65 6443 6572 744b 6579  : []NamedCertKey
000007f0: 7b7b 0a09 0909 094b 6579 4669 6c65 3a20  {{.....KeyFile: 
00000800: 2022 666f 6f2e 6b65 7922 2c0a 0909 0909   "foo.key",.....
00000810: 4365 7274 4669 6c65 3a20 2266 6f6f 2e63  CertFile: "foo.c
00000820: 7274 222c 0a09 0909 094e 616d 6573 3a20  rt",.....Names: 
00000830: 2020 205b 5d73 7472 696e 677b 2261 6263     []string{"abc
00000840: 222c 2022 6465 6622 2c20 2267 6869 227d  ", "def", "ghi"}
00000850: 2c0a 0909 097d 7d2c 0a09 097d 2c0a 0909  ,....}},...},...
00000860: 7b0a 0909 0961 7267 733a 205b 5d73 7472  {....args: []str
00000870: 696e 677b 2266 6f6f 2e63 7274 2c66 6f6f  ing{"foo.crt,foo
00000880: 2e6b 6579 3a2a 2e2a 2e2a 227d 2c0a 0909  .key:*.*.*"},...
00000890: 0965 7870 6563 7465 643a 205b 5d4e 616d  .expected: []Nam
000008a0: 6564 4365 7274 4b65 797b 7b0a 0909 0909  edCertKey{{.....
000008b0: 4b65 7946 696c 653a 2020 2266 6f6f 2e6b  KeyFile:  "foo.k
000008c0: 6579 222c 0a09 0909 0943 6572 7446 696c  ey",.....CertFil
000008d0: 653a 2022 666f 6f2e 6372 7422 2c0a 0909  e: "foo.crt",...
000008e0: 0909 4e61 6d65 733a 2020 2020 5b5d 7374  ..Names:    []st
000008f0: 7269 6e67 7b22 2a2e 2a2e 2a22 7d2c 0a09  ring{"*.*.*"},..
00000900: 0909 7d7d 2c0a 0909 7d2c 0a09 097b 0a09  ..}},...},...{..
00000910: 0909 6172 6773 3a20 5b5d 7374 7269 6e67  ..args: []string
00000920: 7b22 666f 6f2e 6372 742c 666f 6f2e 6b65  {"foo.crt,foo.ke
00000930: 7922 2c20 2262 6172 2e63 7274 2c62 6172  y", "bar.crt,bar
00000940: 2e6b 6579 227d 2c0a 0909 0965 7870 6563  .key"},....expec
00000950: 7465 643a 205b 5d4e 616d 6564 4365 7274  ted: []NamedCert
00000960: 4b65 797b 7b0a 0909 0909 4b65 7946 696c  Key{{.....KeyFil
00000970: 653a 2020 2266 6f6f 2e6b 6579 222c 0a09  e:  "foo.key",..
00000980: 0909 0943 6572 7446 696c 653a 2022 666f  ...CertFile: "fo
00000990: 6f2e 6372 7422 2c0a 0909 097d 2c20 7b0a  o.crt",....}, {.
000009a0: 0909 0909 4b65 7946 696c 653a 2020 2262  ....KeyFile:  "b
000009b0: 6172 2e6b 6579 222c 0a09 0909 0943 6572  ar.key",.....Cer
000009c0: 7446 696c 653a 2022 6261 722e 6372 7422  tFile: "bar.crt"
000009d0: 2c0a 0909 097d 7d2c 0a09 097d 2c0a 097d  ,....}},...},..}
000009e0: 0a09 666f 7220 692c 2074 6573 7420 3a3d  ..for i, test :=
000009f0: 2072 616e 6765 2074 6573 7473 207b 0a09   range tests {..
00000a00: 0966 7320 3a3d 2070 666c 6167 2e4e 6577  .fs := pflag.New
00000a10: 466c 6167 5365 7428 2274 6573 744e 616d  FlagSet("testNam
00000a20: 6564 4365 7274 4b65 7941 7272 6179 222c  edCertKeyArray",
00000a30: 2070 666c 6167 2e43 6f6e 7469 6e75 654f   pflag.ContinueO
00000a40: 6e45 7272 6f72 290a 0909 7661 7220 6e6b  nError)...var nk
00000a50: 6373 205b 5d4e 616d 6564 4365 7274 4b65  cs []NamedCertKe
00000a60: 790a 0909 6e6b 6373 203d 2061 7070 656e  y...nkcs = appen
00000a70: 6428 6e6b 6373 2c20 7465 7374 2e64 6566  d(nkcs, test.def
00000a80: 2e2e 2e29 0a0a 0909 6673 2e56 6172 284e  ...)....fs.Var(N
00000a90: 6577 4e61 6d65 6443 6572 744b 6579 4172  ewNamedCertKeyAr
00000aa0: 7261 7928 266e 6b63 7329 2c20 2274 6c73  ray(&nkcs), "tls
00000ab0: 2d73 6e69 2d63 6572 742d 6b65 7922 2c20  -sni-cert-key", 
00000ac0: 2275 7361 6765 2229 0a0a 0909 6172 6773  "usage")....args
00000ad0: 203a 3d20 5b5d 7374 7269 6e67 7b7d 0a09   := []string{}..
00000ae0: 0966 6f72 205f 2c20 6120 3a3d 2072 616e  .for _, a := ran
00000af0: 6765 2074 6573 742e 6172 6773 207b 0a09  ge test.args {..
00000b00: 0909 6172 6773 203d 2061 7070 656e 6428  ..args = append(
00000b10: 6172 6773 2c20 666d 742e 5370 7269 6e74  args, fmt.Sprint
00000b20: 6628 222d 2d74 6c73 2d73 6e69 2d63 6572  f("--tls-sni-cer
00000b30: 742d 6b65 793d 2573 222c 2061 2929 0a09  t-key=%s", a))..
00000b40: 097d 0a0a 0909 6572 7220 3a3d 2066 732e  .}....err := fs.
00000b50: 5061 7273 6528 6172 6773 290a 0909 6966  Parse(args)...if
00000b60: 2074 6573 742e 7061 7273 6545 7272 6f72   test.parseError
00000b70: 2021 3d20 2222 207b 0a09 0909 6966 2065   != "" {....if e
00000b80: 7272 203d 3d20 6e69 6c20 7b0a 0909 0909  rr == nil {.....
00000b90: 742e 4572 726f 7266 2822 2564 3a20 6578  t.Errorf("%d: ex
00000ba0: 7065 6374 6564 2065 7272 6f72 2025 712c  pected error %q,
00000bb0: 2067 6f74 206e 696c 222c 2069 2c20 7465   got nil", i, te
00000bc0: 7374 2e70 6172 7365 4572 726f 7229 0a09  st.parseError)..
00000bd0: 0909 7d20 656c 7365 2069 6620 2173 7472  ..} else if !str
00000be0: 696e 6773 2e43 6f6e 7461 696e 7328 6572  ings.Contains(er
00000bf0: 722e 4572 726f 7228 292c 2074 6573 742e  r.Error(), test.
00000c00: 7061 7273 6545 7272 6f72 2920 7b0a 0909  parseError) {...
00000c10: 0909 742e 4572 726f 7266 2822 2564 3a20  ..t.Errorf("%d: 
00000c20: 6578 7065 6374 6564 2065 7272 6f72 2025  expected error %
00000c30: 712c 2067 6f74 2025 7122 2c20 692c 2074  q, got %q", i, t
00000c40: 6573 742e 7061 7273 6545 7272 6f72 2c20  est.parseError, 
00000c50: 6572 7229 0a09 0909 7d0a 0909 7d20 656c  err)....}...} el
00000c60: 7365 2069 6620 6572 7220 213d 206e 696c  se if err != nil
00000c70: 207b 0a09 0909 742e 4572 726f 7266 2822   {....t.Errorf("
00000c80: 2564 3a20 6578 7065 6374 6564 206e 696c  %d: expected nil
00000c90: 2065 7272 6f72 2c20 676f 7420 2576 222c   error, got %v",
00000ca0: 2069 2c20 6572 7229 0a09 097d 0a09 0969   i, err)...}...i
00000cb0: 6620 2172 6566 6c65 6374 2e44 6565 7045  f !reflect.DeepE
00000cc0: 7175 616c 286e 6b63 732c 2074 6573 742e  qual(nkcs, test.
00000cd0: 6578 7065 6374 6564 2920 7b0a 0909 0974  expected) {....t
00000ce0: 2e45 7272 6f72 6628 2225 643a 2065 7870  .Errorf("%d: exp
00000cf0: 6563 7465 6420 252b 762c 2067 6f74 2025  ected %+v, got %
00000d00: 2b76 222c 2069 2c20 7465 7374 2e65 7870  +v", i, test.exp
00000d10: 6563 7465 642c 206e 6b63 7329 0a09 097d  ected, nkcs)...}
00000d20: 0a09 7d0a 7d0a                           ..}.}.
